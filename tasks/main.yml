---
- include: version.yml

- name: "HIGH | RHEL-07-010010 | AUDIT | The file permissions, ownership, and group membership of system files and commands must match the vendor values."
  shell: 'rpm -Va | grep ''^.M'''
  failed_when: no
  changed_when: no
  ignore_errors: yes
  register: rhel_07_010010_audit

- name: "HIGH | RHEL-07-010010 | FIX | The file permissions, ownership, and group membership of system files and commands must match the vendor values."
  shell: 'rpm --setperms $(rpm -qf {{ item.split('' '')[-1] }}); rpm --setugids $(rpm -qf {{ item.split('' '')[-1] }})'
  with_items: "{{ rhel_07_010010_audit.stdout_lines }}"
  when: rhel_07_010010_audit.stdout_lines | length > 0

- name: "HIGH | RHEL-07-010020 | AUDIT | The cryptographic hash of system files and commands must match vendor values."
  shell: 'rpm -Va | grep ''^..5'' | grep -E ''/.?bin/'''
  failed_when: no
  changed_when: no
  ignore_errors: yes
  register: rhel_07_010020_audit

- name: "HIGH | RHEL-07-010020 | FIX | The cryptographic hash of system files and commands must match vendor values."
  shell: yum reinstall -y $(rpm -qf {{ item.split(' ')[-1] }})
  with_items: "{{ rhel_07_010020_audit.stdout_lines }}"
  when: rhel_07_010020_audit.stdout_lines | length > 0

- name: "MEDIUM | V-38465 | AUDIT | Library files must have mode 0755 or less permissive"
  become_user: root
  script: sys_libs_with_bad_perms.sh
  register: library_perms_audit
  changed_when: no
  ignore_errors: yes

- name: "MEDIUM | V-38465 | FIX | Library files must have mode 0755 or less permissive"
  file:
      state: file
      mode: "go-w"
      path: "{{ item }}"
  when: library_perms_audit.stdout
  with_items: library_perms_audit.stdout_lines
